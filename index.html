<!DOCSTYLE html>
<html>
    <head>
        <title>WATOR</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <style>
            table  { table-layout: fixed; width: 400; }
            tr     { height: 5px; width: 5px }
            .water { background-color: blue; }
            .fish  { background-color: orange;  }
            .shark  { background-color: white;  }
        </style>
        <script>
            var run = false;
            var cols = 50;
            var rows = 50;
            var startFish = 20;
            var sharkReproAge = 10
            var fishEnergyLevel = 1
            var startSharks = 20;
            var sharkReproAge = 10
            var sharkEnergyLevel = 8
            var data = []
            var sharkData = []

            function setup() {
                var table = $('<table>')
                for (var i = 0; i < rows; i++) {
                    var rowData = []
                    var sharkRowData = []
                    data.push(rowData)
                    sharkData.push(sharkRowData)
                    var row = $('<tr>')
                    table.append(row)
                    for (var j = 0; j < cols; j++) {
                        rowData.push(0)
                        sharkRowData.push(0)
                        row.append($('<td>').attr('class', 'water'))
                    }
                }
                $('#board').append(table)
                make(data, startFish, 'fish', fishEnergyLevel)
                make(sharkData, startSharks, 'shark', sharkEnergyLevel * 16)
                window.setInterval(moveAll, 200);
            }

            function moveAll() {
                moveFish()
                moveSharks()
                updateUI()
            }

            function make(data, numberOf, className, energyLevel) {
                for (var i = 0; i < numberOf; i++ ) {
                    col = Math.floor(cols * Math.random())
                    row = Math.floor(rows * Math.random())
                    data[row][col] = energyLevel
                }
            }

            function updateUI() {
                var tableRows = $('table tr')
                for (var row = 0; row < rows; row++) {
                    for (var col = 0; col < cols; col++) {
                        if (sharkData[row][col] > 0) {
                            tableRows[row].childNodes[col].setAttribute('class', 'shark')
                        } else if (data[row][col] > 0) {
                            tableRows[row].childNodes[col].setAttribute('class', 'fish')
                        } else {
                            tableRows[row].childNodes[col].setAttribute('class', 'water')
                        }
                    }
                }
            }

            function allPossibleNextPositions(isAvailableFn, currPos) {
                available = []
                fns = [up, down, left, right]
                for (var i = 0; i < fns.length; i++) {
                    possibleNextPos = fns[i](currPos)
                    if (isAvailableFn(possibleNextPos)) {
                        available.push(possibleNextPos)
                    }
                }
                return available
            }

            function randomElementOf(available) {
                if (available.length > 0 ){
                    return available[Math.floor(Math.random() * available.length)]
                }
                return null
            }

            function nextSpot(isAvailableFn, currPos) {
                available = allPossibleNextPositions(isAvailableFn, currPos)
                return randomElementOf(available)
            }

            function newFishAt(currPos) {
                fishAt(currPos, 1)
            }

            function removeFishAt(currPos) {
                fishAt(currPos, 0)
            }

            function moveThisFish(newPos, age) {
                fishAt(newPos, (age % 7) + 1)
            }

            function fishShouldReproduce(age) {
                return (1 == (age % 7))
            }

            function fishAge(currPos) {
                return fishAt(currPos)
            }

            function fishEnergy(currPos) {
                return fishAt(currPos) > 0 ? 1 : 0
            }

            function fishDecideMove(currPos) {
                return nextSpot(waterAt, currPos)
            }

            function moveFish() {
                var fns = {
                    energyOf: fishEnergy,
                    decideMove: fishDecideMove,
                    ageOf: fishAge,
                    shouldReproduce: fishShouldReproduce,
                    makeNew: newFishAt,
                    removeAt: removeFishAt,
                    moveThis: moveThisFish
                }
                if (!run) return
                for (var row = 0; row < rows; row++) {
                    for (var col = 0; col < cols; col++) {
                        var currPos = {row: row, col: col}
                        if (fns.energyOf(currPos)) {
                            var hasMoved = true
                            var newPos = fishDecideMove(currPos)
                            if (newPos == null) {
                                newPos = currPos
                                hasMoved = false
                            }

                            var age = fishAge(currPos)
                            var energy = fishEnergy(currPos)

                            if (hasMoved) {
                                if (fishShouldReproduce(age)) {
                                    newFishAt(currPos)
                                } else {
                                    removeFishAt(currPos)
                                }
                            }
                            moveThisFish(newPos, age, energy)
                        } else {
                            removeFishAt(currPos)
                        }
                    }
                }
            }

            function up(y,x) {
                if (x == null) {
                    x = y['row']
                    y = y['col']
                }
                if( x == 0 ) return {row: rows - 1, col: y }
                else return {row: x - 1, col: y }
            }
            function down(y,x) {
                if (x == null) {
                    x = y['row']
                    y = y['col']
                }
                if( x == rows - 1 ) return {row: 0, col: y }
                else return {row: x + 1, col: y }
            }
            function left(y,x) {
                if (x == null) {
                    x = y['row']
                    y = y['col']
                }
                if( y == 0 ) return {row: x, col: cols - 1 }
                else return {row: x, col: y - 1 }
            }
            function right(y,x) {
                if (x == null) {
                    x = y['row']
                    y = y['col']
                }
                if( y == cols - 1 ) return {row: x, col: 0 }
                else return {row: x, col: y + 1 }
            }

            function fishAt(pos, newVal) {
                if (newVal != null) {
                    data[pos['row']][pos['col']] = newVal
                }
                return data[pos['row']][pos['col']]
            }
            function sharkAt(pos, newVal) {
                if (newVal != null) {
                    sharkData[pos['row']][pos['col']] = newVal
                }
                return sharkData[pos['row']][pos['col']]
            }

            function fishTo(start, finish) {
                data[finish['row']][finish['col']] = data[start['row']][start['col']]
            }
            function sharkTo(start, finish) {
                sharkData[finish['row']][finish['col']] = sharkData[start['row']][start['col']]
            }

            function sharkOrFishAt(pos) {
                return sharkAt(pos) > 0 || fishAt(pos) > 0
            }
            function fishButNotShark(pos) {
                return sharkAt(pos) == 0 && fishAt(pos) > 0
            }
            function waterAt(pos) {
                return !sharkOrFishAt(pos)
            }


            function sharkEnergy(pos, newEnergyLevel) {
                var v = Math.floor(sharkAt(pos) / 16)
                if (newEnergyLevel != null) {
                    sharkAt(pos, v * 16 + (v % 16))
                }
                return v - 1
            }

            function newSharkAt(currPos) {
                sharkAt(currPos, sharkEnergyLevel * 16)
            }

            function removeSharkAt(currPos) {
                sharkAt(currPos, 0)
            }

            function moveThisShark(newPos, age, energy) {
                if (fishAt(newPos) > 0) {
                    fishAt(newPos, 0)
                    energy += 3
                    if (energy > sharkEnergyLevel) {
                        energy = sharkEnergyLevel
                    }
                }
                if (energy == 0) {
                    sharkAt(newPos, 0)
                } else {
                    sharkAt(newPos, energy * 16 + ((age + 1) % sharkReproAge))
                }
            }

            function sharkShouldReproduce(age) {
                return age == sharkReproAge - 1
            }

            function sharkAge(currPos) {
                return sharkAt(currPos) % 16
            }

            function sharkDecideMove(currPos) {
                var newPos = nextSpot(fishAt, currPos)
                if (newPos == null) {
                    newPos = nextSpot(waterAt, currPos)
                }
                return newPos
            }

            function moveSharks() {
                var fns = {
                    energyOf: sharkEnergy,
                    decideMove: sharkDecideMove,
                    ageOf: sharkAge,
                    shouldReproduce: sharkShouldReproduce,
                    makeNew: newSharkAt,
                    removeAt: removeSharkAt,
                    moveThis: moveThisShark

                }
                move(fns)
            }
            function move(fns) {
                if (!run) return;
                for (var row = 0; row < rows; row++) {
                    for (var col = 0; col < cols; col++) {
                        var currPos = {row: row, col: col}
                        if (fns.energyOf(currPos) > 0) {
                            var hasMoved = true
                            var newPos = fns.decideMove(currPos)
                            if (newPos == null) {
                                hasMoved = false
                                newPos = currPos
                            }


                            var age = fns.ageOf(currPos)
                            var energy = fns.energyOf(currPos)

                            if (hasMoved) {
                                if (fns.shouldReproduce(age)) {
                                    fns.makeNew(currPos)
                                } else {
                                    fns.removeAt(currPos)
                                }
                            }
                            fns.moveThis(newPos, age, energy)
                        } else {
                            fns.removeAt(currPos)
                        }
                    }
                }
            }

            function toggleRun() {
                run = !run
            }
        </script>
    </head>
    <body>
        <div id="board">
            <button onclick="toggleRun()">Start/Stop</button>
        </div>
        <script>
            $(document).ready(setup);
        </script>
    </body>
</html>
