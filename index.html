<!DOCSTYLE html>
<html>
    <head>
        <title>WATOR</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <style>
            table  { table-layout: fixed; width: 400; }
            tr     { height: 5px; width: 5px }
            .water { background-color: blue; }
            .fish  { background-color: orange;  }
            .shark  { background-color: white;  }
        </style>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            var chartData;
            var addRow = function() {};
            function drawChart() {
                chartData = google.visualization.arrayToDataTable([
                    ['Tick', 'Fish', 'Sharks'],
                    [0,  0,      0]
                ]);

              var options = {
                  title: 'Toroid Population',
                  legend: { position: 'bottom' }
              };

              var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
              addRow = function(rowData) {
                  chartData.addRows([rowData])
                  chart.draw(chartData, options)
              }

            }

            var run = false;
            var cols = 50;
            var rows = 50;
            var startFish = 20;
            var sharkReproAge = 10
            var fishEnergyLevel = 1
            var startSharks = 20;
            var sharkReproAge = 10
            var sharkEnergyLevel = 8
            var numSharks = 0;
            var numFish = 0;
            var data = []
            var sharkData = []

            var fishFns = {
                energyOf: function (currPos) { return fishAt(currPos) > 0 ? 1 : 0 },
                decideMove: function (currPos) { return nextSpot(waterAt, currPos) },
                ageOf: function (currPos) { return fishAt(currPos) },
                shouldReproduce: function(age) { return (1 == (age % 7)) },
                makeNew: function (age) { return (1 == (age % 7)) },
                removeAt: function (currPos) { fishAt(currPos, 0) },
                moveThis: function moveThisFish(newPos, age) { fishAt(newPos, (age % 7) + 1) }
            }

            var sharkFns = {
                energyOf: sharkEnergy,
                decideMove: sharkDecideMove,
                ageOf: function (currPos) { return sharkAt(currPos) % 16 },
                shouldReproduce: function (age) { return age == sharkReproAge - 1 },
                makeNew: function (currPos) { sharkAt(currPos, sharkEnergyLevel * 16) },
                removeAt: function (currPos) { sharkAt(currPos, 0) },
                moveThis: moveThisShark
            }

            function setup() {
                var table = $('<table>')
                for (var i = 0; i < rows; i++) {
                    var rowData = []
                    var sharkRowData = []
                    data.push(rowData)
                    sharkData.push(sharkRowData)
                    var row = $('<tr>')
                    table.append(row)
                    for (var j = 0; j < cols; j++) {
                        rowData.push(0)
                        sharkRowData.push(0)
                        row.append($('<td>').attr('class', 'water'))
                    }
                }
                $('#board').append(table)

                make(data, startFish, 'fish', fishEnergyLevel)
                make(sharkData, startSharks, 'shark', sharkEnergyLevel * 16)

                window.setInterval(moveAll, 200);
            }

            var tick = 0
            function moveAll() {
                if (!run) return
                tick++
                move(fishFns)
                move(sharkFns)
                addRow([tick, numFish, -1 * numSharks])
                updateUI()
            }

            function make(data, numberOf, className, energyLevel) {
                for (var i = 0; i < numberOf; i++ ) {
                    col = Math.floor(cols * Math.random())
                    row = Math.floor(rows * Math.random())
                    data[row][col] = energyLevel
                }
            }

            function updateUI() {
                var tableRows = $('table tr')
                numSharks = 0;
                numFish = 0;
                for (var row = 0; row < rows; row++) {
                    for (var col = 0; col < cols; col++) {
                        var pos = {row: row, col: col}
                        var setClass = function(pos, className) {
                            tableRows[pos.row].childNodes[pos.col].setAttribute('class', className)
                        }
                        if (sharkAt(pos)) {
                            setClass(pos, 'shark')
                            numSharks++
                        } else if (fishAt(pos)) {
                            setClass(pos, 'fish')
                            numFish++
                        } else {
                            setClass(pos, 'water')
                        }
                    }
                }
            }

            function identity(x) { return x }
            function inc(x) { return x + 1 }
            function dec(x) { return x - 1 }

            function dirFn(xfn, yfn) {
                return function(pos) {
                    x = pos['row']
                    y = pos['col']
                    return {row: (xfn(x) + rows) % rows , col: (yfn(y) + cols) % cols }
                }
            }

            function allPossibleNextPositions(isAvailableFn, currPos) {
                available = []
                fns = [ dirFn(dec, identity), 
                        dirFn(inc, identity),
                        dirFn(identity, dec),
                        dirFn(identity, inc)]
                for (var i = 0; i < fns.length; i++) {
                    possibleNextPos = fns[i](currPos)
                    if (isAvailableFn(possibleNextPos)) {
                        available.push(possibleNextPos)
                    }
                }
                return available
            }

            function randomElementOf(available) {
                if (available.length > 0 ){
                    return available[Math.floor(Math.random() * available.length)]
                }
                return null
            }

            function nextSpot(isAvailableFn, currPos) {
                available = allPossibleNextPositions(isAvailableFn, currPos)
                return randomElementOf(available)
            }

            function fishAt(pos, newVal) {
                return at(data, pos, newVal)
            }
            function sharkAt(pos, newVal) {
                return at(sharkData, pos, newVal)
            }
            function at(data, pos, newVal) {
                if (newVal != null) {
                    data[pos['row']][pos['col']] = newVal
                }
                return data[pos['row']][pos['col']]
            }

            function waterAt(pos) {
                return sharkAt(pos) == 0 && fishAt(pos) == 0
            }

            function sharkEnergy(pos, newEnergyLevel) {
                var v = Math.floor(sharkAt(pos) / 16)
                if (newEnergyLevel != null) {
                    sharkAt(pos, v * 16 + (v % 16))
                }
                return v - 1
            }

            function moveThisShark(newPos, age, energy) {
                if (fishAt(newPos) > 0) {
                    fishAt(newPos, 0)
                    energy += 3
                    if (energy > sharkEnergyLevel) {
                        energy = sharkEnergyLevel
                    }
                }
                if (energy == 0) {
                    sharkAt(newPos, 0)
                } else {
                    sharkAt(newPos, energy * 16 + ((age + 1) % sharkReproAge))
                }
            }

            function sharkDecideMove(currPos) {
                var newPos = nextSpot(fishAt, currPos)
                if (newPos == null) {
                    newPos = nextSpot(waterAt, currPos)
                }
                return newPos
            }

            function move(fns) {
                for (var row = 0; row < rows; row++) {
                    for (var col = 0; col < cols; col++) {
                        var currPos = {row: row, col: col}
                        if (fns.energyOf(currPos) > 0) {
                            var hasMoved = true
                            var newPos = fns.decideMove(currPos)
                            if (newPos == null) {
                                hasMoved = false
                                newPos = currPos
                            }


                            var age = fns.ageOf(currPos)
                            var energy = fns.energyOf(currPos)

                            if (hasMoved) {
                                if (fns.shouldReproduce(age)) {
                                    fns.makeNew(currPos)
                                } else {
                                    fns.removeAt(currPos)
                                }
                            }
                            fns.moveThis(newPos, age, energy)
                        } else {
                            fns.removeAt(currPos)
                        }
                    }
                }
            }

            function toggleRun() {
                run = !run
            }
        </script>
    </head>
    <body>
        <div id="board">
            <button onclick="toggleRun()">Start/Stop</button>
        </div>
        <script>
            $(document).ready(setup);
        </script>
        <div id="curve_chart"></div>
    </body>
</html>
